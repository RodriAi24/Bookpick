<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="BookPick">
<title>BookPick</title>
<link rel="icon" type="image/png" href="favicon.png">
<link rel="apple-touch-icon" href="favicon.png">
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#0C0C0C">
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,700;1,400&family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#0C0C0C;--bg2:#151515;--card:#1A1A1A;--card2:#202020;--surface:#272727;
  --ink:#F0EDE8;--ink2:#C4BFB6;--ink3:#7A756D;--ink4:#4A4640;
  --accent:#E8A04C;--accent2:#F2C078;--accent-dim:rgba(232,160,76,.12);
  --green:#6BCB77;--green-dim:rgba(107,203,119,.12);
  --red:#E85D5D;--red-dim:rgba(232,93,93,.1);
  --blue:#60A5FA;--purple:#C084FC;--pink:#F472B6;--teal:#2DD4BF;
  --border:#262626;--radius:16px;--rsm:10px;--rxs:8px;
  --ease:cubic-bezier(.32,.72,0,1);
}
:root { --nav-bg: rgba(12,12,12,0.9); }
body[data-theme="light"]{
  --bg:#F4F4F5;--bg2:#FFFFFF;--card:#FFFFFF;--card2:#FAFAFA;--surface:#E4E4E7;
  --ink:#09090B;--ink2:#3F3F46;--ink3:#71717A;--ink4:#A1A1AA;
  --border:#D4D4D8;
  --nav-bg: rgba(255,255,255,0.9);
}
body[data-theme="light"]::before{opacity:.04}
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
body{font-family:'Outfit',sans-serif;background:var(--bg);color:var(--ink);min-height:100dvh;overflow-x:hidden;-webkit-font-smoothing:antialiased}
body::before{content:'';position:fixed;inset:0;opacity:.02;background-image:url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)'/%3E%3C/svg%3E");pointer-events:none;z-index:9999}
::-webkit-scrollbar{width:0;display:none}
.app{max-width:500px;margin:0 auto;padding:0 0 calc(140px + env(safe-area-inset-bottom)) 0;min-height:100dvh}

/* GRID VIEW */
.blist.grid-view { display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; padding: 0 24px; }
.bcard-grid { display: flex; flex-direction: column; gap: 6px; position: relative; cursor: pointer; animation: cardIn .4s var(--ease) forwards; opacity: 0; transform: translateY(10px); }
.grid-cover { width: 100%; aspect-ratio: 2/3; background: var(--surface); border-radius: 8px; object-fit: cover; box-shadow: 0 4px 12px rgba(0,0,0,0.2); transition: transform .2s; }
.bcard-grid:active .grid-cover { transform: scale(0.95); }
.grid-title { font-family: 'Playfair Display', serif; font-size: 13px; font-weight: 700; line-height: 1.2; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
.grid-author { font-size: 10px; color: var(--ink3); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.grid-badge { position: absolute; top: -6px; right: -6px; width: 22px; height: 22px; background: var(--surface); border: 1px solid var(--border); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 10px; color: var(--accent); z-index: 2; }
.grid-read-badge { position: absolute; top: 6px; left: 6px; width: 22px; height: 22px; background: var(--ink); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 10px; color: var(--bg); z-index: 2; }

/* BOTTOM NAV & FAB */
.nav{position:fixed;bottom:0;left:0;right:0;z-index:90;background:var(--nav-bg);backdrop-filter:blur(12px);-webkit-backdrop-filter:blur(12px);border-top:1px solid var(--border);padding:12px 24px calc(24px + env(safe-area-inset-bottom));display:flex;justify-content:space-around;max-width:500px;margin:0 auto;transition:background 0.3s}
.nav-tab{background:transparent;border:none;color:var(--ink3);font-family:'Outfit',sans-serif;font-size:10px;font-weight:600;display:flex;flex-direction:column;align-items:center;gap:4px;cursor:pointer;transition:all .2s;width:60px}
.nav-icon{font-size:22px;transition:transform .2s;margin-bottom:2px}
.nav-tab.active{color:var(--accent)}
.nav-tab.active .nav-icon{transform:translateY(-3px)}
.fab{position:fixed;bottom:calc(95px + env(safe-area-inset-bottom));right:24px;width:56px;height:56px;border-radius:28px;background:linear-gradient(135deg,var(--accent),#D4892A);color:#0C0C0C;display:flex;align-items:center;justify-content:center;font-size:32px;font-weight:300;box-shadow:0 8px 32px rgba(232,160,76,.35);cursor:pointer;z-index:80;border:none;transition:transform .2s}
.fab:active{transform:scale(.92)}

/* HEADER */
.hero{padding:calc(max(env(safe-area-inset-top), 54px) + 16px) 24px 0;position:relative}
.hero-glow{position:absolute;top:-60px;left:50%;transform:translateX(-50%);width:300px;height:200px;background:radial-gradient(ellipse,rgba(232,160,76,.06) 0%,transparent 70%);pointer-events:none}
.hero-top{display:flex;align-items:center;justify-content:space-between;margin-bottom:20px}
.logo{display:flex;align-items:center;gap:10px}
.logo-icon{width:36px;height:36px;background:var(--accent-dim);border-radius:var(--rxs);display:flex;align-items:center;justify-content:center;font-size:18px}
.logo-text{font-family:'Playfair Display',serif;font-size:22px;font-weight:700;letter-spacing:-.5px}
.logo-text span{color:var(--accent)}
.hero-actions{display:flex;gap:8px}
.icon-btn{width:36px;height:36px;background:var(--card);border:1px solid var(--border);border-radius:var(--rxs);color:var(--ink3);font-size:16px;cursor:pointer;display:flex;align-items:center;justify-content:center}

/* CURRENTLY READING */
.current-section{margin-bottom:20px}
.current-label{font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:1.5px;color:var(--accent);margin-bottom:10px;display:flex;align-items:center;gap:6px}
.current-label::before{content:'';display:inline-block;width:6px;height:6px;background:var(--accent);border-radius:50%;animation:pulse 2s infinite}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.3}}
.current-card{background:linear-gradient(135deg,var(--card),var(--card2));border:1px solid var(--accent);border-radius:var(--radius);padding:18px;position:relative;overflow:hidden}
.current-card::before{content:'';position:absolute;top:0;left:0;right:0;height:2px;background:linear-gradient(90deg,var(--accent),var(--accent2),var(--accent))}
.current-card .book-name{font-size:17px;font-weight:600;margin-bottom:4px}
.current-card .book-author{font-size:13px;color:var(--ink2);margin-bottom:8px}
.current-date{font-size:11px;color:var(--ink3)}
.current-empty{background:var(--card);border:1px dashed var(--border);border-radius:var(--radius);padding:20px;text-align:center;color:var(--ink3);font-size:13px;cursor:pointer}
.current-actions{display:flex;gap:8px;margin-top:10px}
.current-btn{padding:8px 14px;border:none;border-radius:var(--rxs);font-family:'Outfit',sans-serif;font-size:12px;font-weight:600;cursor:pointer}
.current-btn.finish{background:var(--green-dim);color:var(--green)}
.current-btn.stop{background:var(--red-dim);color:var(--red)}

/* STATS ROW */
.stats-row{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin-bottom:16px}
.stat-card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:14px 12px;text-align:center;position:relative;overflow:hidden}
.stat-card::after{content:'';position:absolute;top:0;left:0;right:0;height:2px}
.stat-card:nth-child(1)::after{background:linear-gradient(90deg,transparent,var(--accent),transparent)}
.stat-card:nth-child(2)::after{background:linear-gradient(90deg,transparent,var(--green),transparent)}
.stat-card:nth-child(3)::after{background:linear-gradient(90deg,transparent,var(--blue),transparent)}
.stat-num{font-family:'Playfair Display',serif;font-size:26px;font-weight:700;line-height:1;margin-bottom:3px}
.stat-card:nth-child(1) .stat-num{color:var(--accent)}
.stat-card:nth-child(2) .stat-num{color:var(--green)}
.stat-card:nth-child(3) .stat-num{color:var(--blue)}
.stat-lbl{font-size:10px;font-weight:600;text-transform:uppercase;letter-spacing:.8px;color:var(--ink3)}

/* ANNUAL GOAL */
.goal-section{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:16px;margin-bottom:16px;display:flex;align-items:center;gap:14px}
.goal-ring{width:52px;height:52px;position:relative;flex-shrink:0}
.goal-ring svg{width:52px;height:52px;transform:rotate(-90deg)}
.goal-ring circle{fill:none;stroke-width:4}
.goal-ring .track{stroke:var(--surface)}
.goal-ring .fill{stroke:var(--accent);stroke-linecap:round;transition:stroke-dashoffset .8s var(--ease)}
.goal-num{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-family:'Playfair Display',serif;font-size:14px;font-weight:700;color:var(--accent)}
.goal-info{flex:1}
.goal-title{font-size:14px;font-weight:600;margin-bottom:2px}
.goal-sub{font-size:12px;color:var(--ink3)}
.goal-edit{width:32px;height:32px;border:1px solid var(--border);border-radius:var(--rxs);background:transparent;color:var(--ink3);font-size:14px;cursor:pointer;display:flex;align-items:center;justify-content:center;flex-shrink:0}

/* STREAK */
.streak-section{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:16px;margin-bottom:16px;display:flex;align-items:center;gap:14px}
.streak-fire{font-size:32px}
.streak-info{flex:1}
.streak-num{font-family:'Playfair Display',serif;font-size:20px;font-weight:700;color:var(--accent)}
.streak-lbl{font-size:12px;color:var(--ink3)}

/* CHART */
.chart-section{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:16px;margin-bottom:16px}
.chart-title{font-size:12px;font-weight:600;text-transform:uppercase;letter-spacing:.5px;color:var(--ink3);margin-bottom:14px}
.chart-bars{display:flex;align-items:flex-end;gap:4px;height:80px}
.chart-col{flex:1;display:flex;flex-direction:column;align-items:center;gap:4px}
.chart-bar{width:100%;background:var(--accent-dim);border-radius:3px 3px 0 0;min-height:2px;transition:height .5s var(--ease)}
.chart-bar.has{background:linear-gradient(180deg,var(--accent),rgba(232,160,76,.4))}
.chart-lbl{font-size:9px;color:var(--ink4);font-weight:600}

/* TOP CATEGORY */
.topcat-section{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:16px;margin-bottom:20px;display:flex;align-items:center;gap:14px}
.topcat-emoji{font-size:28px}
.topcat-info{flex:1}
.topcat-title{font-size:14px;font-weight:600}
.topcat-sub{font-size:12px;color:var(--ink3)}

/* RANGE SLIDER */
.range-slider { -webkit-appearance: none; width: 100%; height: 6px; background: rgba(0,0,0,0.3); border-radius: 3px; outline: none; margin: 10px 0; }
.range-slider::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 16px; height: 16px; border-radius: 50%; background: var(--accent); cursor: pointer; }
.range-slider::-moz-range-thumb { width: 16px; height: 16px; border-radius: 50%; background: var(--accent); cursor: pointer; border: none; }

/* PROGRESS */
.progress-section{margin-bottom:20px}
.progress-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px}
.progress-label{font-size:11px;font-weight:600;color:var(--ink3);text-transform:uppercase;letter-spacing:.5px}
.progress-pct{font-family:'Playfair Display',serif;font-size:13px;font-weight:700;color:var(--accent)}
.progress-track{height:5px;background:var(--surface);border-radius:3px;overflow:hidden}
.progress-fill{height:100%;background:linear-gradient(90deg,var(--accent),var(--accent2));border-radius:3px;transition:width .8s var(--ease)}

/* ACTIONS ELIMINADAS (Movidas a Bot√≥n Flotante) */

/* SEARCH + CONTROLS */
.search-section{padding:0 24px 12px}
.search-bar{display:flex;align-items:center;gap:10px;background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:0 14px;transition:border-color .2s}
.search-bar:focus-within{border-color:var(--accent)}
.search-icon{color:var(--ink3);font-size:15px;flex-shrink:0}
.search-input{flex:1;padding:13px 0;border:none;background:transparent;font-family:'Outfit',sans-serif;font-size:14px;color:var(--ink);outline:none}
.search-input::placeholder{color:var(--ink3)}
.search-clear{width:22px;height:22px;border-radius:50%;border:none;background:var(--surface);color:var(--ink3);font-size:11px;cursor:pointer;display:none;align-items:center;justify-content:center}
.search-clear.show{display:flex}

.controls-row{padding:0 24px 14px;display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:12px}
.filters{display:flex;gap:8px;flex-wrap:wrap}
.fchip{padding:6px 12px;border-radius:18px;border:1px solid var(--border);font-family:'Outfit',sans-serif;font-size:12px;font-weight:500;cursor:pointer;background:transparent;color:var(--ink3);transition:all .2s}
.fchip.active{background:var(--accent-dim);border-color:var(--accent);color:var(--accent)}
.sort-btn{padding:6px 10px;border-radius:18px;border:1px solid var(--border);font-family:'Outfit',sans-serif;font-size:12px;font-weight:500;cursor:pointer;background:transparent;color:var(--ink3)}

.cats-scroll{padding:0 24px 12px;display:flex;gap:6px;overflow-x:auto;-webkit-overflow-scrolling:touch}
.cchip{padding:6px 12px;border-radius:18px;border:1px solid var(--border);font-family:'Outfit',sans-serif;font-size:11px;font-weight:500;cursor:pointer;background:transparent;color:var(--ink3);white-space:nowrap;transition:all .2s;flex-shrink:0}
.cchip.active{background:var(--accent-dim);border-color:var(--accent);color:var(--accent)}
.cbadge{display:inline-block;background:var(--surface);color:var(--ink3);font-size:10px;font-weight:600;padding:1px 6px;border-radius:8px;margin-left:4px}

/* BOOK LIST */
.blist{padding:0 24px;display:flex;flex-direction:column;gap:0}
.bcard{background:transparent;border:none;border-bottom:1px solid var(--border);border-radius:0;padding:16px 4px;display:flex;align-items:flex-start;gap:16px;transition:background .2s var(--ease),transform .2s var(--ease);animation:cardIn .4s var(--ease) forwards;opacity:0;transform:translateY(10px);touch-action:pan-y}
.bcard:last-child{border-bottom:none}
@keyframes cardIn{to{opacity:1;transform:translateY(0)}}
.bcard.read-c{opacity:.5}
.bcard.picked-c{border-left:3px solid var(--accent);background:var(--accent-dim);padding-left:12px}
.bcard.reading-c{border-left:3px solid var(--green);background:var(--green-dim);padding-left:12px}
.bcard.swiping{transition:transform .2s}

.bcheck{width:22px;height:22px;border-radius:6px;border:1.5px solid var(--ink3);background:transparent;cursor:pointer;flex-shrink:0;display:flex;align-items:center;justify-content:center;transition:all .2s;font-size:12px;color:transparent;margin-top:2px}
.bcheck.done{background:var(--ink);border-color:var(--ink);color:var(--bg)}
.bcheck:active{transform:scale(.85)}

.bbody{flex:1;min-width:0}
.bname{font-family:'Playfair Display',serif;font-size:16px;font-weight:700;line-height:1.2;color:var(--ink);margin-bottom:4px;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}
.read-c .bname{text-decoration:line-through;text-decoration-color:var(--ink3)}
.bauthor{font-family:'Outfit',sans-serif;font-size:12px;color:var(--ink3);text-transform:uppercase;letter-spacing:.5px;margin-bottom:8px}
.bmeta{display:flex;align-items:center;gap:6px;flex-wrap:wrap}
.btag{display:inline-block;padding:2px 7px;border-radius:4px;font-size:9px;font-weight:700;text-transform:uppercase;letter-spacing:.4px}
.bstars{font-size:12px;letter-spacing:1px;color:var(--accent)}
.bdate{font-size:10px;color:var(--ink4)}
.bnote-preview{font-size:11px;color:var(--ink3);font-style:italic;margin-top:4px;display:-webkit-box;-webkit-line-clamp:1;-webkit-box-orient:vertical;overflow:hidden}

.bactions{display:flex;flex-direction:column;gap:2px;flex-shrink:0}
.bdel{width:28px;height:28px;border:none;background:transparent;color:var(--ink3);cursor:pointer;font-size:13px;opacity:.25;border-radius:var(--rxs);display:flex;align-items:center;justify-content:center;flex-shrink:0}
.bdel:active{opacity:1;color:var(--red);background:var(--red-dim)}

/* Category tag colors */
.cat-mundo{background:rgba(96,165,250,.12);color:#60A5FA}
.cat-psicologia{background:rgba(244,114,182,.12);color:#F472B6}
.cat-filosofia{background:rgba(192,132,252,.12);color:#C084FC}
.cat-finanzas{background:rgba(52,211,153,.12);color:#34D399}
.cat-crypto{background:var(--accent-dim);color:var(--accent)}
.cat-geopolitica{background:rgba(251,146,60,.12);color:#FB923C}
.cat-historia{background:rgba(167,139,113,.12);color:#A78B71}
.cat-astronomia{background:rgba(129,140,248,.12);color:#818CF8}
.cat-observacion{background:rgba(45,212,191,.12);color:#2DD4BF}
.cat-thriller{background:rgba(239,68,68,.12);color:#EF4444}
.cat-must{background:rgba(250,204,21,.12);color:#FACC15}
.cat-otro{background:var(--surface);color:var(--ink3)}

/* EMPTY */
.empty{text-align:center;padding:50px 24px}
.empty-icon{font-size:44px;margin-bottom:14px;opacity:.6}
.empty-text{font-size:14px;color:var(--ink3);line-height:1.6}

/* SHEETS / MODALS */
.overlay{position:fixed;inset:0;background:rgba(0,0,0,.6);backdrop-filter:blur(8px);-webkit-backdrop-filter:blur(8px);z-index:100;opacity:0;pointer-events:none;transition:opacity .3s}
.overlay.open{opacity:1;pointer-events:all}
.sheet{position:fixed;bottom:0;left:0;right:0;z-index:101;background:var(--bg2);border-radius:24px 24px 0 0;padding:20px 24px calc(24px + env(safe-area-inset-bottom));max-height:85dvh;overflow-y:auto;transform:translateY(100%);transition:transform .35s var(--ease);max-width:500px;margin:0 auto}
.sheet.open{transform:translateY(0)}
.sheet-handle{width:36px;height:4px;background:var(--surface);border-radius:2px;margin:0 auto 18px}
.sheet-title{font-family:'Playfair Display',serif;font-size:20px;font-weight:700;margin-bottom:18px}

.sheet-tabs{display:flex;background:var(--card);border-radius:var(--rsm);padding:3px;margin-bottom:16px}
.sheet-tab{flex:1;padding:9px;border:none;border-radius:var(--rxs);font-family:'Outfit',sans-serif;font-size:13px;font-weight:500;cursor:pointer;background:transparent;color:var(--ink3);transition:all .2s}
.sheet-tab.active{background:var(--surface);color:var(--ink)}

.flabel{font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:.5px;color:var(--ink3);margin-bottom:6px;display:block}
.finput{width:100%;padding:12px 14px;border:1px solid var(--border);border-radius:var(--rsm);font-family:'Outfit',sans-serif;font-size:15px;outline:none;background:var(--card);color:var(--ink);transition:border-color .2s;margin-bottom:14px}
.finput:focus{border-color:var(--accent)}
.ftextarea{width:100%;padding:12px 14px;border:1px solid var(--border);border-radius:var(--rsm);font-family:'Outfit',sans-serif;font-size:15px;outline:none;background:var(--card);color:var(--ink);resize:none;height:140px;line-height:1.5;margin-bottom:6px}
.ftextarea:focus{border-color:var(--accent)}
.fhint{font-size:11px;color:var(--ink3);margin-bottom:14px}

.cat-select{display:flex;flex-wrap:wrap;gap:5px;margin-bottom:16px}
.cat-opt{padding:6px 11px;border-radius:18px;border:1px solid var(--border);font-family:'Outfit',sans-serif;font-size:11px;font-weight:500;cursor:pointer;background:transparent;color:var(--ink3);transition:all .2s}
.cat-opt.picked{background:var(--accent-dim);border-color:var(--accent);color:var(--accent)}

.sbtn{width:100%;padding:15px;border:none;border-radius:var(--radius);background:linear-gradient(135deg,var(--accent),#D4892A);color:#0C0C0C;font-family:'Outfit',sans-serif;font-size:15px;font-weight:700;cursor:pointer}
.sbtn:active{transform:scale(.98);opacity:.9}
.sbtn.secondary{background:var(--card);border:1px solid var(--border);color:var(--ink)}
.sbtn.danger{background:var(--red-dim);border:1px solid var(--red);color:var(--red)}

/* STARS INPUT */
.stars-input{display:flex;gap:4px;margin-bottom:14px}
.star-btn{width:32px;height:32px;border:1px solid var(--border);border-radius:var(--rxs);background:var(--card);font-size:16px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .2s}
.star-btn.lit{background:var(--accent-dim);border-color:var(--accent)}

/* NOTES INPUT */
.notes-input{width:100%;padding:12px 14px;border:1px solid var(--border);border-radius:var(--rsm);font-family:'Outfit',sans-serif;font-size:14px;outline:none;background:var(--card);color:var(--ink);resize:none;height:80px;line-height:1.5;margin-bottom:14px}
.notes-input:focus{border-color:var(--accent)}

/* PICK MODAL */
.pick-ov{position:fixed;inset:0;background:rgba(0,0,0,.7);backdrop-filter:blur(12px);-webkit-backdrop-filter:blur(12px);z-index:200;display:flex;align-items:center;justify-content:center;opacity:0;pointer-events:none;transition:opacity .3s}
.pick-ov.show{opacity:1;pointer-events:all}
.pick-modal{background:var(--bg2);border:1px solid var(--border);border-radius:28px;padding:40px 28px 32px;text-align:center;max-width:340px;width:calc(100% - 48px);transform:scale(.85) translateY(20px);transition:transform .45s cubic-bezier(.34,1.56,.64,1);position:relative;overflow:hidden}
.pick-modal::before{content:'';position:absolute;top:0;left:0;right:0;height:3px;background:linear-gradient(90deg,var(--accent),var(--accent2),var(--accent))}
.pick-ov.show .pick-modal{transform:scale(1) translateY(0)}
.pick-emoji{font-size:52px;margin-bottom:16px;transition:transform .3s}
.pick-label{font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:2px;color:var(--accent);margin-bottom:12px}
.pick-book{font-family:'Playfair Display',serif;font-size:21px;font-weight:700;line-height:1.3;margin-bottom:6px;color:var(--ink);transition:opacity .2s}
.pick-author{font-size:13px;color:var(--ink3);margin-bottom:8px;transition:opacity .2s}
.pick-cat-tag{display:inline-block;padding:3px 10px;border-radius:12px;font-size:10px;font-weight:600;margin-bottom:28px}
.pick-actions{display:flex;gap:8px}
.pick-btn{flex:1;padding:13px;border:none;border-radius:var(--rsm);font-family:'Outfit',sans-serif;font-size:14px;font-weight:600;cursor:pointer}
.pick-btn:active{transform:scale(.96)}
.pick-btn.primary{background:linear-gradient(135deg,var(--accent),#D4892A);color:#0C0C0C}
.pick-btn.secondary{background:var(--card);border:1px solid var(--border);color:var(--ink2)}
.pick-btn.reading{background:var(--green-dim);border:1px solid var(--green);color:var(--green)}

/* TOAST */
.toast{position:fixed;bottom:90px;left:50%;transform:translateX(-50%) translateY(20px);background:var(--ink);color:var(--bg);padding:11px 22px;border-radius:var(--rsm);font-size:13px;font-weight:600;opacity:0;transition:all .3s ease;z-index:300;white-space:nowrap;box-shadow:0 8px 32px rgba(0,0,0,.3)}
.toast.show{opacity:1;transform:translateX(-50%) translateY(0)}

/* DETAIL SHEET extras */
.detail-header{display:flex;gap:14px;margin-bottom:16px;align-items:flex-start}
.detail-info{flex:1}
.detail-title{font-family:'Playfair Display',serif;font-size:20px;font-weight:700;margin-bottom:4px}
.detail-author{font-size:14px;color:var(--ink2);margin-bottom:8px}
.detail-tag{display:inline-block;padding:3px 10px;border-radius:12px;font-size:10px;font-weight:600}
.detail-divider{height:1px;background:var(--border);margin:16px 0}
.detail-section-title{font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:1px;color:var(--ink3);margin-bottom:10px}
.detail-stars{display:flex;gap:6px;margin-bottom:16px}
.detail-star{font-size:24px;cursor:pointer;transition:transform .2s}
.detail-star:active{transform:scale(1.3)}
.detail-notes{width:100%;padding:12px;border:1px solid var(--border);border-radius:var(--rsm);font-family:'Outfit',sans-serif;font-size:14px;background:var(--card);color:var(--ink);resize:none;height:100px;line-height:1.5;outline:none;margin-bottom:16px}
.detail-notes:focus{border-color:var(--accent)}
.detail-notes::placeholder{color:var(--ink4)}
.detail-date{font-size:12px;color:var(--ink3);margin-bottom:16px}

/* Settings extras */
.setting-row{display:flex;align-items:center;justify-content:space-between;padding:14px 0;border-bottom:1px solid var(--border)}
.setting-label{font-size:14px;font-weight:500}
.setting-value{font-size:14px;color:var(--ink2)}
.goal-input{width:60px;padding:8px;border:1px solid var(--border);border-radius:var(--rxs);background:var(--card);color:var(--ink);font-family:'Outfit',sans-serif;font-size:14px;text-align:center;outline:none}
.goal-input:focus{border-color:var(--accent)}

/* Page sections */
.page{display:none}
.page.active{display:block}

/* CIRCULAR PROGRESS & EMPTY STATE (HOME) */
.home-empty { text-align: center; padding: 40px 20px; background: transparent; border: 1px solid var(--border); border-radius: var(--radius); margin-bottom: 24px; }
.home-empty-title { font-family: 'Playfair Display', serif; font-size: 20px; font-weight: 700; margin-bottom: 8px; color: var(--ink); }
.home-empty-text { font-family: 'Outfit', sans-serif; font-size: 14px; color: var(--ink3); margin-bottom: 24px; }

.ring-container { position: relative; width: 140px; height: 140px; margin: 0 auto 20px; display:flex; align-items:center; justify-content:center; }
.ring { position: absolute; inset: 0; border-radius: 50%; background: conic-gradient(var(--accent) var(--pct), var(--surface) 0); -webkit-mask: radial-gradient(farthest-side, transparent calc(100% - 8px), #fff calc(100% - 8px)); mask: radial-gradient(farthest-side, transparent calc(100% - 8px), #fff calc(100% - 8px)); transition: --pct .8s ease; }
.ring-center { text-align: center; z-index: 1; display: flex; flex-direction: column; }
.ring-pct { font-family: 'Playfair Display', serif; font-size: 32px; font-weight: 700; color: var(--ink); line-height: 1; }
.ring-lbl { font-size: 11px; font-weight: 600; color: var(--ink3); text-transform: uppercase; letter-spacing: 1px; margin-top: 4px; }

/* STREAK PILL (HEADER) */
.streak-pill { font-family: 'Outfit', sans-serif; font-size: 13px; font-weight: 700; color: var(--accent); display: flex; align-items: center; gap: 4px; background: var(--card); padding: 4px 12px; border-radius: 20px; border: 1px solid var(--border); box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
.streak-pill span { color: var(--ink); }

/* MAGIC SEARCH */
.api-results { max-height:240px; overflow-y:auto; margin-bottom:16px; display:flex; flex-direction:column; gap:8px; }
.api-item { display:flex; gap:12px; padding:10px; background:var(--card2); border:1px solid var(--border); border-radius:var(--rsm); cursor:pointer; transition:all .2s; }
.api-item.selected { border-color:var(--accent); background:var(--accent-dim); }
.api-thumb { width:42px; height:64px; background:var(--surface); border-radius:4px; object-fit:cover; flex-shrink:0; box-shadow:0 2px 8px rgba(0,0,0,0.2); }
.api-info { flex:1; min-width:0; display:flex; flex-direction:column; justify-content:center; }
.api-title { font-family:'Playfair Display',serif; font-size:15px; font-weight:700; color:var(--ink); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; margin-bottom:4px; }
.api-author { font-size:12px; color:var(--ink3); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
.api-pages { font-size:10px; color:var(--ink4); margin-top:6px; font-weight:600; text-transform:uppercase; letter-spacing:1px; }
.api-selected-tray { display:flex; flex-wrap:wrap; gap:6px; margin-bottom:12px; }
.api-sel-chip { background:var(--accent); color:#0C0C0C; font-size:11px; font-weight:700; padding:6px 12px; border-radius:16px; display:flex; align-items:center; gap:6px; box-shadow:0 2px 8px rgba(232,160,76,0.3); animation: fadeIn 0.2s ease; }

</style>
</head>
<body>
<div class="app">
  <!-- NAV -->
  <div class="page active" id="page-home">
    <div class="hero">
      <div class="hero-glow"></div>
      <div class="hero-top" style="position:relative; display:flex; justify-content:space-between; align-items:center;">
        <div class="streak-pill" style="margin:0; font-size:14px; padding:6px 14px;">üî• <span class="streak-count">0</span></div>
        <div class="logo-text" style="position:absolute; left:50%; transform:translateX(-50%); font-size:22px;">Book<span>Pick</span></div>
        <button class="icon-btn theme-btn" onclick="toggleTheme()" style="border:none; background:var(--surface);">‚òÄÔ∏è</button>
      </div>

      <div class="current-section" id="currentSection"></div>

      <div class="stats-row">
        <div class="stat-card"><div class="stat-num" id="sT">0</div><div class="stat-lbl">Total</div></div>
        <div class="stat-card"><div class="stat-num" id="sR">0</div><div class="stat-lbl">Le√≠dos</div></div>
        <div class="stat-card"><div class="stat-num" id="sU">0</div><div class="stat-lbl">Pendientes</div></div>
      </div>

      <div style="background:var(--card); border-radius:var(--radius); padding:24px; margin-bottom:24px; text-align:center;">
        <div class="ring-container">
          <div class="ring" id="homeRing" style="--pct:0%"></div>
          <div class="ring-center">
            <span class="ring-pct" id="homeRingPct">0%</span>
            <span class="ring-lbl">Completado</span>
          </div>
        </div>
        <div style="font-size:13px; color:var(--ink3); margin-top: -10px" id="homeRingMsg">Tu colecci√≥n te espera.</div>
      </div>
    </div>
  </div>

  <div class="page" id="page-library">
    <div class="hero">
      <div class="hero-glow"></div>
      <div class="hero-top" style="position:relative; display:flex; justify-content:space-between; align-items:center;">
        <div class="streak-pill" style="margin:0; font-size:14px; padding:6px 14px;">üî• <span class="streak-count">0</span></div>
        <div class="logo-text" style="position:absolute; left:50%; transform:translateX(-50%); font-size:22px;">Book<span>Pick</span></div>
        <button class="icon-btn theme-btn" onclick="toggleTheme()" style="border:none; background:var(--surface);">‚òÄÔ∏è</button>
      </div>

      <div style="display:flex;background:var(--card);border-radius:var(--rsm);padding:4px;margin-bottom:16px">
        <button id="viewLibBtn" onclick="setView('library')" style="flex:1;padding:10px;border:none;border-radius:var(--rxs);background:var(--surface);color:var(--ink);font-family:'Outfit',sans-serif;font-weight:600;font-size:13px;cursor:pointer;transition:all .2s">Mis Libros</button>
        <button id="viewWishBtn" onclick="setView('wishlist')" style="flex:1;padding:10px;border:none;border-radius:var(--rxs);background:transparent;color:var(--ink3);font-family:'Outfit',sans-serif;font-weight:600;font-size:13px;cursor:pointer;transition:all .2s">Wishlist</button>
      </div>
      
      <button class="sbtn" style="margin-bottom:20px; display:flex; align-items:center; justify-content:center; gap:8px; font-size:16px; box-shadow:0 8px 24px rgba(232,160,76,.25)" onclick="pickRandom()"><span>üé≤</span> Random Pick</button>
    </div>

    <div class="search-section">
      <div class="search-bar">
        <span class="search-icon">üîç</span>
        <input class="search-input" id="searchIn" type="text" placeholder="Buscar libro o autor..." oninput="onSearch()">
        <button class="search-clear" id="searchCl" onclick="clearSearch()">‚úï</button>
      </div>
    </div>

    <div class="controls-row">
      <div class="filters">
        <button class="fchip active" onclick="setFilter('all',this)">Todos</button>
        <button class="fchip" onclick="setFilter('unread',this)">Pendientes</button>
        <button class="fchip" onclick="setFilter('read',this)">Le√≠dos</button>
      </div>
      <div style="display:flex; gap:8px;">
        <button class="sort-btn" onclick="toggleViewMode()" id="viewModeBtn">üî≤ Grilla</button>
        <button class="sort-btn" onclick="cycleSort()" id="sortBtn">Autor A‚ÜíZ</button>
      </div>
    </div>

    <div class="cats-scroll" id="catScroll"></div>
    <div class="blist" id="bookList"></div>
  </div>

  <!-- ‚ïê‚ïê‚ïê STATS PAGE ‚ïê‚ïê‚ïê -->
  <div class="page" id="page-stats">
    <div class="hero">
      <div class="hero-glow"></div>
      <div class="hero-top" style="position:relative; display:flex; justify-content:space-between; align-items:center;">
        <div class="streak-pill" style="margin:0; font-size:14px; padding:6px 14px;">üî• <span class="streak-count">0</span></div>
        <div class="logo-text" style="position:absolute; left:50%; transform:translateX(-50%); font-size:22px;">Book<span>Pick</span></div>
        <button class="icon-btn theme-btn" onclick="toggleTheme()" style="border:none; background:var(--surface);">‚òÄÔ∏è</button>
      </div>
    </div>
    <div style="padding:16px 24px">
      <div id="goalSection"></div>
      <div id="streakSection"></div>
      <div id="chartSection"></div>
      <div id="topcatSection"></div>
      <div id="catBreakdown"></div>
      
      <button class="sbtn" style="margin-top:24px;background:var(--card);color:var(--accent);border:1px solid var(--accent-dim)" onclick="shareTop5()">üì∏ Compartir mi Top 5 (IG Story)</button>
    </div>
  </div>

  <div class="page" id="page-settings">
    <div class="hero">
      <div class="hero-glow"></div>
      <div class="hero-top" style="position:relative; display:flex; justify-content:space-between; align-items:center;">
        <div class="streak-pill" style="margin:0; font-size:14px; padding:6px 14px;">üî• <span class="streak-count">0</span></div>
        <div class="logo-text" style="position:absolute; left:50%; transform:translateX(-50%); font-size:22px;">Book<span>Pick</span></div>
        <button class="icon-btn theme-btn" onclick="toggleTheme()" style="border:none; background:var(--surface);">‚òÄÔ∏è</button>
      </div>
    </div>
    <div style="padding:16px 24px">
      <div class="setting-row">
        <span class="setting-label">Meta anual de libros</span>
        <input class="goal-input" id="goalIn" type="number" min="1" max="200" onchange="saveGoal()">
      </div>
      <div style="margin-top:24px; padding-bottom:16px; border-bottom:1px solid var(--border)">
        <p style="font-size:13px;color:var(--ink3);margin-bottom:14px">Buscar portadas y p√°ginas de los libros antiguos que agregaste manualmente o ven√≠an en la base.</p>
        <button class="sbtn secondary" id="syncBtn" onclick="syncOldBooks()">üîÑ Sincronizar libros antiguos</button>
      </div>
      <div style="margin-top:16px">
        <p style="font-size:13px;color:var(--ink3);margin-bottom:14px">Reiniciar vuelve a los 66 libros originales y borra todo tu progreso.</p>
        <button class="sbtn danger" onclick="resetLib()">Reiniciar biblioteca</button>
      </div>
      <div style="margin-top:16px; display:flex; gap:10px; flex-direction:column;">
        <button class="sbtn secondary" onclick="exportData()">üì§ Exportar Backup (JSON)</button>
        <label class="sbtn secondary" style="text-align:center;display:block;cursor:pointer">
          üì• Importar Backup
          <input type="file" accept=".json" style="display:none" onchange="importData(event)">
        </label>
      </div>
    </div>
  </div>
</div>

<!-- ADD SHEET -->
<button class="fab" onclick="openAdd()">+</button>
<div class="nav">
  <button class="nav-tab active" id="tab-home" onclick="showPage('home')"><div class="nav-icon">üè†</div>Inicio</button>
  <button class="nav-tab" id="tab-library" onclick="showPage('library')"><div class="nav-icon">üìö</div>Libros</button>
  <button class="nav-tab" id="tab-stats" onclick="showPage('stats')"><div class="nav-icon">üìä</div>Stats</button>
  <button class="nav-tab" id="tab-settings" onclick="showPage('settings')"><div class="nav-icon">‚öôÔ∏è</div>Ajustes</button>
</div>

<div class="overlay" id="addOv" onclick="closeAdd()"></div>
<div class="sheet" id="addSh">
  <div class="sheet-handle"></div>
  <div class="sheet-title">Agregar libros</div>
  <div class="sheet-tabs">
    <button class="sheet-tab active" onclick="setAddMode('magic',this)">üåü Buscador</button>
    <button class="sheet-tab" onclick="setAddMode('manual',this)">‚úçÔ∏è Manual</button>
  </div>
  
  <div id="addMagicV">
    <div class="search-bar" style="margin-bottom:12px; background:var(--card2)">
      <span class="search-icon">üîç</span>
      <input class="search-input" id="apiSearchIn" type="text" placeholder="Buscar t√≠tulo o autor en la red..." oninput="onApiSearch()">
    </div>
    <div class="api-selected-tray" id="apiSelTray"></div>
    <div class="api-results" id="apiResults">
      <div style="text-align:center;padding:30px 20px;color:var(--ink4);font-size:13px">Busc√° un libro para ver opciones reales. Pod√©s tocar varios para agregarlos al mismo tiempo.</div>
    </div>
    <label class="flabel">Forzar categor√≠a (Opcional - Auto detecta de la red)</label>
    <div class="cat-select" id="csM"></div>
    <button class="sbtn" id="magicSubmitBtn" onclick="submitMagicAdd()">Agregar Selecci√≥n</button>
  </div>

  <div id="addManualV" style="display:none">
    <label class="flabel">Autor ‚Äì T√≠tulo (Un libro por l√≠nea)</label>
    <textarea class="ftextarea" id="bulkIn" placeholder="Ej: Carl Sagan ‚Äì Cosmos&#10;Pod√©s pegar listas enteras ac√°."></textarea>
    <label class="flabel">Categor√≠a (Opcional)</label>
    <div class="cat-select" id="csB"></div>
    <button class="sbtn" id="manualSubmitBtn" onclick="submitManualAdd()">Agregar Manualmente</button>
  </div>
</div>

<!-- DETAIL / EDIT SHEET -->
<div class="overlay" id="detOv" onclick="closeDetail()"></div>
<div class="sheet" id="detSh">
  <div class="sheet-handle"></div>
  <div id="detContent"></div>
</div>

<!-- PICK MODAL -->
<div class="pick-ov" id="pickOv">
  <div class="pick-modal" onclick="event.stopPropagation()">
    <div class="pick-emoji" id="pickEmoji">üé≤</div>
    <div class="pick-label">Tu pr√≥ximo libro</div>
    <div class="pick-book" id="pickB"></div>
    <div class="pick-author" id="pickA"></div>
    <div class="pick-cat-tag" id="pickCat"></div>
    <div class="pick-actions">
      <button class="pick-btn secondary" onclick="pickAnother()">üîÑ Otro</button>
      <button class="pick-btn reading" onclick="startReading()" id="pickReadBtn">üìñ Leer</button>
      <button class="pick-btn primary" onclick="closePick()">‚úì</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
// ‚ïê‚ïê‚ïê CONSTANTS ‚ïê‚ïê‚ïê
const CATS=[
  {id:'mundo',label:'Mundo',css:'cat-mundo',emoji:'üåç'},
  {id:'psicologia',label:'Psicolog√≠a',css:'cat-psicologia',emoji:'üß†'},
  {id:'filosofia',label:'Filosof√≠a',css:'cat-filosofia',emoji:'üîÆ'},
  {id:'finanzas',label:'Finanzas',css:'cat-finanzas',emoji:'üí∞'},
  {id:'crypto',label:'Crypto',css:'cat-crypto',emoji:'‚Çø'},
  {id:'geopolitica',label:'Geopol√≠tica',css:'cat-geopolitica',emoji:'üåê'},
  {id:'historia',label:'Historia',css:'cat-historia',emoji:'‚è≥'},
  {id:'astronomia',label:'Astronom√≠a',css:'cat-astronomia',emoji:'üöÄ'},
  {id:'observacion',label:'Observaci√≥n',css:'cat-observacion',emoji:'üî≠'},
  {id:'thriller',label:'Thriller',css:'cat-thriller',emoji:'üíÄ'},
  {id:'must',label:'Must Read',css:'cat-must',emoji:'‚≠ê'}
];
const MONTHS=['Ene','Feb','Mar','Abr','May','Jun','Jul','Ago','Sep','Oct','Nov','Dic'];
const SORT_MODES=['author-az','author-za','title-az','title-za'];
const SORT_LABELS=['Autor A‚ÜíZ','Autor Z‚ÜíA','T√≠tulo A‚ÜíZ','T√≠tulo Z‚ÜíA'];

const DB=[];

// ‚ïê‚ïê‚ïê STATE ‚ïê‚ïê‚ïê
let books,state;
const gid=()=>Date.now().toString(36)+Math.random().toString(36).slice(2,7);
const esc=s=>{const d=document.createElement('div');d.textContent=s;return d.innerHTML};
const parse=f=>{const i=f.indexOf(' ‚Äì ');if(i>0)return{a:f.substring(0,i),t:f.substring(i+3)};const j=f.indexOf(' - ');if(j>0)return{a:f.substring(0,j),t:f.substring(j+3)};return{a:'',t:f}};
const catInfo=id=>CATS.find(c=>c.id===id)||{label:id||'Otro',css:'cat-otro',emoji:'üìñ'};
const today=()=>new Date().toISOString().split('T')[0];

function init(){
  const savedTheme = localStorage.getItem('bp_theme') || 'dark';
  if(savedTheme === 'light') {
    document.body.setAttribute('data-theme', 'light');
    document.querySelectorAll('.theme-btn').forEach(btn => btn.textContent = 'üåô');
    document.querySelector('meta[name="theme-color"]').setAttribute('content', '#F4F4F5');
  }

  const s=localStorage.getItem('bp3_books');
  if(s)books=JSON.parse(s);
  else{books=DB.map(b=>({id:gid(),title:b.t,cat:b.c,read:false,rating:0,notes:'',readDate:null,startDate:null,wishlist:false,pages:0,cover:''}));save()}
  
  books.forEach(b=>{
    if(b.rating===undefined)b.rating=0;if(!b.notes)b.notes='';if(!b.readDate)b.readDate=null;if(!b.startDate)b.startDate=null;
    if(b.wishlist===undefined)b.wishlist=false;if(b.progress===undefined)b.progress=0;
    if(b.pages===undefined)b.pages=0;if(b.cover===undefined)b.cover='';
  });
  
  const st=localStorage.getItem('bp3_state');
  state=st?JSON.parse(st):{goal:20,sortIdx:0,filter:'all',catFilter:'all',view:'library',listMode:'list'};
  if(!state.goal)state.goal=20;
  if(state.sortIdx===undefined)state.sortIdx=0;
  if(!state.view)state.view='library';
  if(!state.listMode)state.listMode='list';
  
  document.getElementById('goalIn').value=state.goal;
  
  setTimeout(() => {
    setView(state.view);
    showPage('home');
  }, 50);
}

function save(){localStorage.setItem('bp3_books',JSON.stringify(books))}
function saveState(){localStorage.setItem('bp3_state',JSON.stringify(state))}

// ‚ïê‚ïê‚ïê PAGES ‚ïê‚ïê‚ïê
let currentPage='home';
function showPage(p){
  currentPage=p;
  document.querySelectorAll('.page').forEach(x=>x.classList.remove('active'));
  document.getElementById('page-'+p).classList.add('active');
  document.querySelectorAll('.nav-tab').forEach(x=>x.classList.remove('active'));
  document.getElementById('tab-'+p).classList.add('active');
  
  if(p==='home') { renderHome(); }
  if(p==='library') { renderLibrary(); }
  if(p==='stats') { renderStats(); }
  if(p==='settings') { document.getElementById('goalIn').value=state.goal; }
}

function setView(v){
  state.view=v; saveState();
  const isLib = v==='library';
  document.getElementById('viewLibBtn').style.background = isLib ? 'var(--surface)' : 'transparent';
  document.getElementById('viewLibBtn').style.color = isLib ? 'var(--ink)' : 'var(--ink3)';
  document.getElementById('viewWishBtn').style.background = !isLib ? 'var(--surface)' : 'transparent';
  document.getElementById('viewWishBtn').style.color = !isLib ? 'var(--ink)' : 'var(--ink3)';
  renderLibrary();
}

// ‚ïê‚ïê‚ïê RENDERING ‚ïê‚ïê‚ïê
let sq='',addM='single',selC='',pickId=null;

function renderAll() {
  renderHome();
  renderLibrary();
  if(currentPage==='stats') renderStats();
  updateHeaderStreak();
}

// Funci√≥n maestra para calcular racha (ignora zonas horarias conflictivas)
function calculateGlobalStreak() {
  const readDates = books.filter(b => b.read && b.readDate).map(b => b.readDate);
  if(!readDates.length) return 0;
  
  const fmt = (dt) => dt.getFullYear() + '-' + String(dt.getMonth()+1).padStart(2,'0') + '-' + String(dt.getDate()).padStart(2,'0');
  const getMonday = (dStr) => {
    const [y, m, d] = dStr.split('-');
    const date = new Date(y, m - 1, d);
    const day = date.getDay() || 7; 
    date.setDate(date.getDate() - day + 1);
    return fmt(date);
  };

  const uniqueWeeks = [...new Set(readDates.map(getMonday))].sort((a,b) => new Date(b.replace(/-/g,'/')) - new Date(a.replace(/-/g,'/')));
  const currentMonday = getMonday(today());
  let lastWeekDate = new Date(); lastWeekDate.setDate(lastWeekDate.getDate() - 7);
  const lastMonday = getMonday(fmt(lastWeekDate));

  let streak = 0;
  if (uniqueWeeks[0] === currentMonday || uniqueWeeks[0] === lastMonday) {
    let expectedMonday = uniqueWeeks[0];
    for (let wk of uniqueWeeks) {
      if (wk === expectedMonday) {
        streak++;
        const [y, m, d] = expectedMonday.split('-');
        let prev = new Date(y, m - 1, d);
        prev.setDate(prev.getDate() - 7);
        expectedMonday = fmt(prev);
      } else break;
    }
  }
  return streak;
}

function updateHeaderStreak() {
  const streak = calculateGlobalStreak();
  document.querySelectorAll('.streak-count').forEach(el => el.textContent = streak);
}

function renderHome() {
  renderCurrentlyReading();
  renderMiniStats();
}

function renderLibrary() {
  renderCats();
  renderBookList();
}

let showAllReading = false;

function toggleShowAllReading() {
  showAllReading = !showAllReading;
  renderCurrentlyReading();
}

function renderCurrentlyReading(){
  const el=document.getElementById('currentSection');
  const readingBooks = books.filter(b => b.startDate && !b.read && !b.wishlist);
  
  if(readingBooks.length > 0){
    const visibleBooks = showAllReading ? readingBooks : readingBooks.slice(0, 2);
    
    let html = `<div class="current-label">Leyendo ahora</div><div style="display:flex;flex-direction:column;gap:12px;">`;
    
    html += visibleBooks.map(b => {
      const{a,t}=parse(b.title);
      return `
      <div class="current-card">
        <div class="book-name">${esc(t||b.title)}</div>
        <div class="book-author">${esc(a)}</div>
        <div class="current-date" style="display:flex;align-items:center;gap:6px">
          üìÖ Empezado el <input type="date" value="${b.startDate||today()}" style="background:transparent;border:none;color:var(--ink3);font-family:'Outfit',sans-serif;font-size:11px;outline:none" onchange="updateStartDate('${b.id}',this.value)">
        </div>
        
        <div style="margin-top:12px;margin-bottom:12px">
          <div style="display:flex;justify-content:space-between;align-items:center;font-size:11px;color:var(--ink3);margin-bottom:4px">
            <span>Progreso</span>
            ${b.pages > 0 ? 
              `<span style="display:flex;align-items:center;gap:4px">
                <input type="number" id="pgIn_${b.id}" value="${Math.round((b.progress||0)*b.pages/100)}" style="width:48px;background:var(--card);border:1px solid var(--border);border-radius:4px;color:var(--ink);font-family:'Outfit',sans-serif;font-size:11px;text-align:center;padding:3px 0;outline:none" onblur="updatePageProgress('${b.id}', this.value, ${b.pages})"> / ${b.pages}
              </span>` 
              : `<span id="progLbl_${b.id}">${b.progress||0}%</span>`
            }
          </div>
          <input type="range" class="range-slider" min="0" max="100" value="${b.progress||0}" 
                 style="background: linear-gradient(90deg, var(--accent) ${b.progress||0}%, rgba(0,0,0,0.3) ${b.progress||0}%);"
                 oninput="
                   ${b.pages > 0 ? `document.getElementById('pgIn_${b.id}').value = Math.round(this.value * ${b.pages} / 100);` : `document.getElementById('progLbl_${b.id}').textContent = this.value + '%';`}
                   this.style.background = 'linear-gradient(90deg, var(--accent) ' + this.value + '%, rgba(0,0,0,0.3) ' + this.value + '%)';
                 " 
                 onchange="updateProgressValue('${b.id}', this.value)">
        </div>

        <div class="current-actions">
          <button class="current-btn finish" onclick="finishCurrent('${b.id}')">‚úì Termin√©</button>
          <button class="current-btn stop" onclick="stopReading('${b.id}')">‚úï Dejar</button>
        </div>
      </div>`;
    }).join('');

    if(readingBooks.length > 2) {
      html += `<button class="current-empty" style="padding:10px; border:1px dashed var(--border); background:var(--card); color:var(--ink3); border-radius:var(--rxs); cursor:pointer; font-size:12px; font-family:'Outfit',sans-serif; font-weight:600; text-align:center" onclick="toggleShowAllReading()">${showAllReading ? '‚ñ≤ Ocultar lecturas' : `‚ñº Ver ${readingBooks.length - 2} lecturas m√°s`}</button>`;
    }

    html += `</div>`;
    el.innerHTML = html;
  } else {
    el.innerHTML = `
      <div class="home-empty">
        <div class="home-empty-title">Tu rinc√≥n de lectura</div>
        <div class="home-empty-text">A√∫n no ten√©s lecturas activas. Eleg√≠ un libro de tu biblioteca para empezar.</div>
        <button class="sbtn secondary" style="max-width:200px; margin:0 auto; border-color:var(--accent-dim); color:var(--accent);" onclick="showPage('library')">Explorar mis libros</button>
      </div>`;
  }
}

function renderMiniStats(){
  const lib = books.filter(b=>!b.wishlist);
  const r=lib.filter(b=>b.read).length;
  document.getElementById('sT').textContent=lib.length;
  document.getElementById('sR').textContent=r;
  document.getElementById('sU').textContent=lib.length-r;

  // L√≥gica del Anillo Circular
  const total = lib.length;
  const pct = total > 0 ? Math.round((r / total) * 100) : 0;
  
  const ring = document.getElementById('homeRing');
  const ringPct = document.getElementById('homeRingPct');
  const ringMsg = document.getElementById('homeRingMsg');
  
  if(ring && ringPct && ringMsg) {
    ring.style.setProperty('--pct', `${pct}%`);
    ringPct.textContent = `${pct}%`;
    
    let msg = "Tu colecci√≥n te espera.";
    if(pct > 0) msg = "¬°Buen comienzo! Segu√≠ as√≠.";
    if(pct > 30) msg = "Avanzando a paso firme.";
    if(pct > 60) msg = "¬°Ya pasaste la mitad de tus libros!";
    if(pct === 100 && total > 0) msg = "¬°Le√≠ste toda tu biblioteca! üéâ";
    ringMsg.textContent = msg;
  }
}

function renderCats(){
  const cc={};books.forEach(b=>{cc[b.cat]=(cc[b.cat]||0)+1});
  const el=document.getElementById('catScroll');
  let h=`<button class="cchip ${state.catFilter==='all'?'active':''}" onclick="setCat('all')">Todas</button>`;
  CATS.forEach(c=>{if(cc[c.id])h+=`<button class="cchip ${state.catFilter===c.id?'active':''}" onclick="setCat('${c.id}')">${c.emoji} ${c.label}<span class="cbadge">${cc[c.id]}</span></button>`});
  el.innerHTML=h;
  ['csM','csB'].forEach(id=>{
    const e=document.getElementById(id);
    if(e)e.innerHTML=CATS.map(c=>`<button class="cat-opt" onclick="selCatFn('${c.id}',this)">${c.emoji} ${c.label}</button>`).join('');
  });
}

function getFiltered(){
  const isW = state.view === 'wishlist';
  let l=books.filter(b => !!b.wishlist === isW);
  if(!isW && state.filter==='read')l=l.filter(b=>b.read);
  if(!isW && state.filter==='unread')l=l.filter(b=>!b.read);
  if(state.catFilter!=='all')l=l.filter(b=>b.cat===state.catFilter);
  if(sq){const q=sq.toLowerCase();l=l.filter(b=>b.title.toLowerCase().includes(q))}
  const mode=SORT_MODES[state.sortIdx]||'author-az';
  l.sort((a,b)=>{
    const pa=parse(a.title),pb=parse(b.title);
    if(mode==='author-az')return(pa.a||pa.t).localeCompare(pb.a||pb.t,'es');
    if(mode==='author-za')return(pb.a||pb.t).localeCompare(pa.a||pa.t,'es');
    if(mode==='title-az')return(pa.t||a.title).localeCompare(pb.t||b.title,'es');
    if(mode==='title-za')return(pb.t||b.title).localeCompare(pa.t||a.title,'es');
  });
  return l;
}

function renderBookList(){
  const el=document.getElementById('bookList'),fl=getFiltered();
  document.getElementById('sortBtn').textContent=SORT_LABELS[state.sortIdx];
  const viewBtn = document.getElementById('viewModeBtn');
  if(viewBtn) viewBtn.textContent = state.listMode === 'list' ? 'üî≤ Grilla' : 'üìÑ Lista';
  
  if(!fl.length){
    el.className = 'blist';
    const ic=sq?'üîç':state.filter==='read'?'‚úÖ':'üìñ';
    const mg=sq?'Sin resultados':state.filter==='read'?'No le√≠ste ninguno a√∫n':state.filter==='unread'?'Nada pendiente':'Sin libros';
    el.innerHTML=`<div class="empty"><div class="empty-icon">${ic}</div><div class="empty-text">${mg}</div></div>`;return;
  }
  
  if (state.listMode === 'grid') {
    el.className = 'blist grid-view';
    el.innerHTML = fl.map((b,i)=>{
      const{a,t}=parse(b.title);
      return`<div class="bcard-grid" style="animation-delay:${Math.min(i*.02,.6)}s" onclick="openDetail('${b.id}')">
        ${b.read ? `<div class="grid-read-badge">‚úì</div>` : ''}
        ${b.rating > 0 ? `<div class="grid-badge">‚òÖ</div>` : ''}
        ${b.cover ? `<img src="${b.cover}" class="grid-cover" style="opacity:${b.read?0.5:1}">` : `<div class="grid-cover" style="display:flex;align-items:center;justify-content:center;text-align:center;padding:10px;font-size:10px;color:var(--ink3)">Sin Portada</div>`}
        <div class="grid-title" style="opacity:${b.read?0.5:1}">${esc(t||b.title)}</div>
        <div class="grid-author" style="opacity:${b.read?0.5:1}">${esc(a)}</div>
      </div>`;
    }).join('');
  } else {
    el.className = 'blist';
    el.innerHTML=fl.map((b,i)=>{
      const{a,t}=parse(b.title);const ci=catInfo(b.cat);
      const isReading=b.startDate && !b.read;
      const stars=b.rating?'‚òÖ'.repeat(b.rating)+'‚òÜ'.repeat(5-b.rating):'';
      return`<div class="bcard ${b.read?'read-c':''} ${b.id===pickId?'picked-c':''} ${isReading?'reading-c':''}" style="animation-delay:${Math.min(i*.02,.6)}s" onclick="openDetail('${b.id}')" ontouchstart="tStart(event,'${b.id}')" ontouchmove="tMove(event,'${b.id}')" ontouchend="tEnd(event,'${b.id}')">
        <button class="bcheck ${b.read?'done':''}" onclick="event.stopPropagation();toggleRead('${b.id}')">${b.read?'‚úì':''}</button>
        ${b.cover ? `<img src="${b.cover}" style="width:45px;height:68px;object-fit:cover;border-radius:4px;flex-shrink:0;box-shadow:0 2px 8px rgba(0,0,0,0.2)">` : ''}
        <div class="bbody">
          <div class="bname">${esc(t||b.title)}</div> 
          ${a?`<div class="bauthor">${esc(a)}</div>`:''}
          <div class="bmeta">
            <span class="btag ${ci.css}">${ci.emoji} ${ci.label}</span>
            ${stars?`<span class="bstars">${stars}</span>`:''}
            ${b.readDate?`<span class="bdate">${formatDate(b.readDate)}</span>`:''}
          </div>
          ${b.notes?`<div class="bnote-preview">üìù ${esc(b.notes)}</div>`:''}
        </div>
        <button class="bdel" onclick="event.stopPropagation();del('${b.id}')">‚úï</button>
      </div>`;
    }).join('');
  }
}

// ‚ïê‚ïê‚ïê STATS PAGE ‚ïê‚ïê‚ïê
function renderStats(){
  renderGoal();renderStreak();renderChart();renderTopCat();renderCatBreakdown();
}

function renderGoal(){
  const read=books.filter(b=>b.read).length;
  const goal=state.goal||20;
  const pct=Math.min(Math.round(read/goal*100),100);
  const circ=2*Math.PI*22;
  const offset=circ-(pct/100)*circ;
  document.getElementById('goalSection').innerHTML=`
    <div class="goal-section">
      <div class="goal-ring">
        <svg viewBox="0 0 52 52"><circle class="track" cx="26" cy="26" r="22"/><circle class="fill" cx="26" cy="26" r="22" stroke-dasharray="${circ}" stroke-dashoffset="${offset}"/></svg>
        <div class="goal-num">${pct}%</div>
      </div>
      <div class="goal-info">
        <div class="goal-title">Meta 2026: ${goal} libros</div>
        <div class="goal-sub">${read} de ${goal} completados</div>
      </div>
    </div>`;
}

function renderStreak(){
  const streak = calculateGlobalStreak();
  document.getElementById('streakSection').innerHTML=`
    <div class="streak-section">
      <div class="streak-fire">${streak>0?'üî•':'‚ùÑÔ∏è'}</div>
      <div class="streak-info">
        <div class="streak-num">${streak} ${streak===1?'semana':'semanas'}</div>
        <div class="streak-lbl">${streak>0?'Racha de lectura activa':'Empez√° a leer para armar racha'}</div>
      </div>
    </div>`;
}

function renderChart(){
  const yr=new Date().getFullYear();
  const monthly=Array(12).fill(0);
  books.filter(b=>b.readDate&&b.readDate.startsWith(yr)).forEach(b=>{
    const m=parseInt(b.readDate.split('-')[1])-1;monthly[m]++;
  });
  const max=Math.max(...monthly,1);
  document.getElementById('chartSection').innerHTML=`
    <div class="chart-section">
      <div class="chart-title">Libros le√≠dos por mes ‚Äî ${yr}</div>
      <div class="chart-bars">
        ${monthly.map((v,i)=>`<div class="chart-col"><div class="chart-bar ${v?'has':''}" style="height:${Math.max(v/max*100,3)}%"></div><div class="chart-lbl">${MONTHS[i]}</div></div>`).join('')}
      </div>
    </div>`;
}

function renderTopCat(){
  const catRead={};
  books.filter(b=>b.read).forEach(b=>{catRead[b.cat]=(catRead[b.cat]||0)+1});
  const entries=Object.entries(catRead).sort((a,b)=>b[1]-a[1]);
  if(!entries.length){document.getElementById('topcatSection').innerHTML='';return}
  const top=entries[0];
  const ci=catInfo(top[0]);
  document.getElementById('topcatSection').innerHTML=`
    <div class="topcat-section">
      <div class="topcat-emoji">${ci.emoji}</div>
      <div class="topcat-info">
        <div class="topcat-title">${ci.label}</div>
        <div class="topcat-sub">Tu categor√≠a m√°s le√≠da (${top[1]} libros)</div>
      </div>
    </div>`;
}

function renderCatBreakdown(){
  const catAll={},catRead={};
  books.forEach(b=>{catAll[b.cat]=(catAll[b.cat]||0)+1;if(b.read)catRead[b.cat]=(catRead[b.cat]||0)+1});
  const el=document.getElementById('catBreakdown');
  el.innerHTML=`<div class="chart-section"><div class="chart-title">Por categor√≠a</div>
    ${CATS.filter(c=>catAll[c.id]).map(c=>{
      const all=catAll[c.id]||0,read=catRead[c.id]||0,pct=Math.round(read/all*100);
      return`<div style="display:flex;align-items:center;gap:10px;margin-bottom:10px">
        <span style="font-size:16px;width:24px;text-align:center">${c.emoji}</span>
        <span style="font-size:13px;font-weight:500;width:90px">${c.label}</span>
        <div style="flex:1;height:6px;background:var(--surface);border-radius:3px;overflow:hidden"><div style="height:100%;width:${pct}%;background:var(--accent);border-radius:3px;transition:width .5s"></div></div>
        <span style="font-size:11px;color:var(--ink3);width:50px;text-align:right">${read}/${all}</span>
      </div>`;
    }).join('')}
  </div>`;
}

// ‚ïê‚ïê‚ïê ACTIONS ‚ïê‚ïê‚ïê
function toggleRead(id){
  const b=books.find(x=>x.id===id);
  if(!b)return;
  b.read=!b.read;
  if(b.read){b.readDate=today();b.progress=100;}
  else{b.readDate=null}
  save();renderAll();
}

function del(id){
  if(!confirm('¬øEliminar este libro?'))return;
  books=books.filter(x=>x.id!==id);save();renderAll();
}

function setFilter(f,el){state.filter=f;saveState();document.querySelectorAll('.fchip').forEach(c=>c.classList.remove('active'));el.classList.add('active');renderBookList()}
function setCat(c){state.catFilter=c;saveState();renderCats();renderBookList()}
function cycleSort(){state.sortIdx=(state.sortIdx+1)%SORT_MODES.length;saveState();renderBookList()}
function toggleViewMode(){state.listMode=state.listMode==='list'?'grid':'list';saveState();renderBookList()}
function onSearch(){sq=document.getElementById('searchIn').value.trim();document.getElementById('searchCl').classList.toggle('show',sq.length>0);renderBookList()}
function clearSearch(){document.getElementById('searchIn').value='';sq='';document.getElementById('searchCl').classList.remove('show');renderBookList()}

// ‚ïê‚ïê‚ïê CURRENTLY READING ‚ïê‚ïê‚ïê
function startReadingBook(id){
  const b=books.find(x=>x.id===id);
  if(!b)return;
  b.startDate=today();
  b.wishlist=false;
  save();renderAll();
  toast('üìñ Empezaste a leer!');
}

function finishCurrent(id){
  const b=books.find(x=>x.id===id);
  if(b){b.read=true;b.readDate=today();b.progress=100;save()}
  renderAll();
  toast('üéâ Libro completado!');
}

function stopReading(id){
  const b=books.find(x=>x.id===id);
  if(b){b.startDate=null;save()}
  renderAll();
}

function updateStartDate(id, dateStr) {
  const b = books.find(x => x.id === id);
  if (b) { b.startDate = dateStr; save(); toast('Fecha actualizada'); }
}

function updateProgressValue(id, val) {
  const b = books.find(x => x.id === id);
  if (!b) return;
  b.progress = parseInt(val);
  save(); renderAll();
}

function updatePageProgress(id, pagesRead, totalPages) {
  const b = books.find(x => x.id === id);
  if (!b) return;
  let p = parseInt(pagesRead) || 0;
  if(p < 0) p = 0;
  if(p > totalPages) p = totalPages;
  b.progress = Math.round((p / totalPages) * 100);
  save(); renderAll();
}

// ‚ïê‚ïê‚ïê RANDOM PICK ‚ïê‚ïê‚ïê
function pickRandom(){
  const isW = state.view === 'wishlist';
  const u = books.filter(b => !!b.wishlist === isW && !b.read);
  if(!u.length){toast(isW ? 'Tu wishlist est√° vac√≠a üõí' : '¬°Le√≠ste todos! üéâ');return}
  const p=u[Math.floor(Math.random()*u.length)];pickId=p.id;
  showPickModal(p);renderBookList();
}

function showPickModal(b){
  const{a,t}=parse(b.title);const ci=catInfo(b.cat);
  document.getElementById('pickEmoji').textContent=ci.emoji;
  document.getElementById('pickB').textContent=t||b.title;
  document.getElementById('pickA').textContent=a||'';
  const tag=document.getElementById('pickCat');
  tag.textContent=ci.label;tag.className='pick-cat-tag '+ci.css;
  document.getElementById('pickOv').classList.add('show');
}

function pickAnother(){
  const isW = state.view === 'wishlist';
  const u = books.filter(b => !!b.wishlist === isW && !b.read && b.id!==pickId);
  if(!u.length){toast('No hay m√°s opciones');return}
  const p=u[Math.floor(Math.random()*u.length)];pickId=p.id;
  const{a,t}=parse(p.title);const ci=catInfo(p.cat);
  const be=document.getElementById('pickB'),ae=document.getElementById('pickA'),em=document.getElementById('pickEmoji'),tag=document.getElementById('pickCat');
  be.style.opacity='0';ae.style.opacity='0';em.style.transform='rotate(360deg)';
  setTimeout(()=>{
    em.textContent=ci.emoji;be.textContent=t||p.title;ae.textContent=a||'';
    tag.textContent=ci.label;tag.className='pick-cat-tag '+ci.css;
    be.style.opacity='1';ae.style.opacity='1';em.style.transform='rotate(0deg)';
  },200);
  renderBookList();
}

function startReading(){
  if(pickId){startReadingBook(pickId);closePick()}
}

function closePick(){document.getElementById('pickOv').classList.remove('show');setTimeout(()=>{pickId=null;renderBookList()},300)}
document.getElementById('pickOv').addEventListener('click',e=>{if(e.target===document.getElementById('pickOv'))closePick()});

// ‚ïê‚ïê‚ïê ADD MODAL & MAGIC SEARCH ‚ïê‚ïê‚ïê
let apiTimer, currentApiResults=[], selectedApiBooks=[];

function openAdd(){
  selC=''; addM='magic'; selectedApiBooks=[]; currentApiResults=[];
  document.getElementById('apiSearchIn').value='';
  document.getElementById('bulkIn').value='';
  document.getElementById('apiResults').innerHTML='<div style="text-align:center;padding:30px 20px;color:var(--ink4);font-size:13px">Busc√° un libro para ver opciones reales. Pod√©s tocar varios para agregarlos al mismo tiempo.</div>';
  renderApiSelected();
  
  // Detectar si estamos en la Wishlist
  const isWish = (currentPage === 'library' && state.view === 'wishlist');
  const btnText = isWish ? 'Agregar a Wishlist üõí' : 'Agregar a Biblioteca üìö';
  document.getElementById('magicSubmitBtn').textContent = btnText;
  document.getElementById('manualSubmitBtn').textContent = btnText;

  document.getElementById('addOv').classList.add('open');
  document.getElementById('addSh').classList.add('open');
  renderCats(); setAddMode('magic', document.querySelector('.sheet-tab.active'));
  setTimeout(()=>{document.getElementById('apiSearchIn').focus()},350);
}

function closeAdd(){document.getElementById('addOv').classList.remove('open');document.getElementById('addSh').classList.remove('open')}
function setAddMode(m,el){addM=m;document.querySelectorAll('.sheet-tab').forEach(t=>t.classList.remove('active'));if(el)el.classList.add('active');document.getElementById('addMagicV').style.display=m==='magic'?'block':'none';document.getElementById('addManualV').style.display=m==='manual'?'block':'none'}
function selCatFn(c,el){
  if(el.classList.contains('picked')){ el.classList.remove('picked'); selC=''; return; } // Permitir deseleccionar
  el.parentElement.querySelectorAll('.cat-opt').forEach(o=>o.classList.remove('picked'));
  el.classList.add('picked'); selC=c;
}

// API Fetching
function onApiSearch() {
  clearTimeout(apiTimer);
  const q = document.getElementById('apiSearchIn').value.trim();
  const resEl = document.getElementById('apiResults');
  if(!q) { resEl.innerHTML=''; return; }
  
  resEl.innerHTML = '<div style="text-align:center;padding:20px;color:var(--ink3)">Buscando en la red... ‚è≥</div>';
  apiTimer = setTimeout(async () => {
    try {
      const res = await fetch(`https://www.googleapis.com/books/v1/volumes?q=${encodeURIComponent(q)}&maxResults=15`);
      const data = await res.json();
      if(!data.items) { resEl.innerHTML='<div style="text-align:center;padding:20px;color:var(--ink3)">No se encontraron libros.</div>'; return; }
      
      currentApiResults = data.items.map(i => {
        const vi = i.volumeInfo;
        return {
          apiId: i.id, title: vi.title || 'Sin t√≠tulo', author: vi.authors ? vi.authors[0] : 'Desconocido',
          pages: vi.pageCount || 0, cover: vi.imageLinks ? vi.imageLinks.thumbnail.replace('http:','https:') : '',
          rawCat: vi.categories && vi.categories.length > 0 ? vi.categories[0] : ''
        };
      });
      renderApiList();
    } catch(e) {
      resEl.innerHTML = '<div style="text-align:center;padding:20px;color:var(--red)">Sin conexi√≥n. Us√° la pesta√±a Manual.</div>';
    }
  }, 600);
}

function renderApiList() {
  const html = currentApiResults.map(b => {
    const isSel = selectedApiBooks.some(x => x.apiId === b.apiId);
    return `<div class="api-item ${isSel?'selected':''}" onclick="toggleApiBook('${b.apiId}')">
      ${b.cover ? `<img src="${b.cover}" class="api-thumb">` : `<div class="api-thumb"></div>`}
      <div class="api-info">
        <div class="api-title">${b.title}</div>
        <div class="api-author">${b.author}</div>
        <div class="api-pages">üìë ${b.pages} p√°gs</div>
      </div>
      <div style="font-size:18px;align-self:center">${isSel?'‚úÖ':'+'}</div>
    </div>`;
  }).join('');
  document.getElementById('apiResults').innerHTML = html;
}

function toggleApiBook(apiId) {
  const idx = selectedApiBooks.findIndex(x => x.apiId === apiId);
  if(idx >= 0) selectedApiBooks.splice(idx, 1);
  else {
    const b = currentApiResults.find(x => x.apiId === apiId);
    if(b) selectedApiBooks.push(b);
  }
  renderApiList(); renderApiSelected();
}

function renderApiSelected() {
  const html = selectedApiBooks.map(b => `<div class="api-sel-chip" onclick="toggleApiBook('${b.apiId}')">${b.title} ‚úï</div>`).join('');
  document.getElementById('apiSelTray').innerHTML = html;
}

function autoCat(raw) {
  if(!raw) return 'otro';
  const r = raw.toLowerCase();
  if(r.includes('psychology')||r.includes('self-help')) return 'psicologia';
  if(r.includes('philosophy')) return 'filosofia';
  if(r.includes('business')||r.includes('economics')||r.includes('finance')) return 'finanzas';
  if(r.includes('history')) return 'historia';
  if(r.includes('science')||r.includes('physics')||r.includes('astronomy')) return 'astronomia';
  if(r.includes('thriller')||r.includes('fiction')||r.includes('mystery')||r.includes('suspense')) return 'thriller';
  return 'otro';
}

function submitMagicAdd() {
  if(!selectedApiBooks.length) { toast('Seleccion√° al menos un libro'); return; }
  const ex=new Set(books.map(b=>b.title.toLowerCase())); let n=0;
  const isWish = (currentPage === 'library' && state.view === 'wishlist');
  
  selectedApiBooks.forEach(b => {
    const formatTitle = `${b.author} ‚Äì ${b.title}`;
    if(!ex.has(formatTitle.toLowerCase())) {
      const finalCat = selC || autoCat(b.rawCat);
      books.push({id:gid(), title:formatTitle, cat:finalCat, read:false, rating:0, notes:'', readDate:null, startDate:null, wishlist:isWish, progress:0, pages:b.pages, cover:b.cover});
      ex.add(formatTitle.toLowerCase()); n++;
    }
  });
  books.sort((a,b)=>a.title.localeCompare(b.title,'es')); save(); renderAll(); closeAdd();
  toast(n===0?'Ya ten√≠as esos libros':n===1?'1 libro agregado ‚úì':`${n} libros agregados ‚úì`);
}

function submitManualAdd(){
  const ts=document.getElementById('bulkIn').value.split('\n').map(l=>l.trim()).filter(l=>l);
  if(!ts.length){toast('Escrib√≠ al menos un t√≠tulo');return}
  const ex=new Set(books.map(b=>b.title.toLowerCase()));let n=0;
  const isWish = (currentPage === 'library' && state.view === 'wishlist');

  ts.forEach(t=>{if(!ex.has(t.toLowerCase())){books.push({id:gid(),title:t,cat:selC||'otro',read:false,rating:0,notes:'',readDate:null,startDate:null,wishlist:isWish,progress:0,pages:0,cover:''});ex.add(t.toLowerCase());n++}});
  books.sort((a,b)=>a.title.localeCompare(b.title,'es'));save();renderAll();closeAdd();
  toast(n===0?'Ya ten√≠as esos libros':n===1?'Libro agregado ‚úì':`${n} libros agregados ‚úì`);
}

async function syncOldBooks() {
  const btn = document.getElementById('syncBtn');
  const toSync = books.filter(b => !b.cover || !b.pages);
  if(!toSync.length) { toast('¬°Todos tus libros ya est√°n actualizados! ‚ú®'); return; }
  
  btn.textContent = `Sincronizando ${toSync.length} libros... ‚è≥`;
  btn.style.pointerEvents = 'none';
  let updated = 0;

  for(let b of toSync) {
    try {
      const res = await fetch(`https://www.googleapis.com/books/v1/volumes?q=${encodeURIComponent(b.title)}&maxResults=1`);
      const data = await res.json();
      if(data.items && data.items.length > 0) {
        const vi = data.items[0].volumeInfo;
        if(!b.cover && vi.imageLinks) b.cover = vi.imageLinks.thumbnail.replace('http:','https:');
        if(!b.pages && vi.pageCount) b.pages = vi.pageCount;
        updated++;
      }
    } catch(e) {}
    await new Promise(r => setTimeout(r, 200)); // Pausa de cortes√≠a para no saturar a Google
  }

  save(); renderAll();
  btn.textContent = 'üîÑ Sincronizar libros antiguos';
  btn.style.pointerEvents = 'auto';
  toast(`Se actualizaron ${updated} libros üìö`);
}

// ‚ïê‚ïê‚ïê DETAIL / EDIT SHEET ‚ïê‚ïê‚ïê
let detailBookId=null;
function openDetail(id){
  detailBookId=id;
  const b=books.find(x=>x.id===id);if(!b)return;
  const{a,t}=parse(b.title);const ci=catInfo(b.cat);
  const stars=Array(5).fill(0).map((_,i)=>
    `<span class="detail-star" onclick="setRating('${id}',${i+1})">${i<b.rating?'‚òÖ':'‚òÜ'}</span>`
  ).join('');

  document.getElementById('detContent').innerHTML=`
    <div class="detail-header">
      <div class="detail-info">
        <input type="text" id="editTitleIn" value="${esc(t||b.title)}" style="font-family:'Playfair Display',serif;font-size:20px;font-weight:700;margin-bottom:4px;background:transparent;border:none;color:var(--ink);width:100%;border-bottom:1px dashed transparent;outline:none" onblur="updateBookData('${id}')">
        <input type="text" id="editAuthorIn" value="${esc(a)}" style="font-size:14px;color:var(--ink2);margin-bottom:8px;background:transparent;border:none;width:100%;border-bottom:1px dashed transparent;outline:none" onblur="updateBookData('${id}')">
        <div style="display:flex; align-items:center; gap:8px">
          <span class="detail-tag ${ci.css}">${ci.emoji} ${ci.label}</span>
          <span class="detail-tag" style="background:var(--surface);color:var(--ink);display:flex;align-items:center;gap:4px;font-size:11px">
            üìë <b style="color:var(--accent)">${b.pages||0}</b> p√°gs
          </span>
        </div>
      </div>
    </div>
    ${b.readDate?`<div class="detail-date">‚úÖ Le√≠do el ${formatDate(b.readDate)}</div>`:''}
    ${b.startDate&&!b.read?`<div class="detail-date">üìñ Leyendo desde ${formatDate(b.startDate)}</div>`:''}
    <div class="detail-divider"></div>
    <div class="detail-section-title">Rating</div>
    <div class="detail-stars">${stars}</div>
    <div class="detail-section-title">Notas</div>
    <textarea class="detail-notes" id="detNotes" placeholder="Anot√° ideas, frases, reflexiones..." onblur="saveNotes('${id}')">${esc(b.notes||'')}</textarea>
    <div class="detail-section-title">Categor√≠a</div>
    <div class="cat-select" id="detCatSelect">${CATS.map(c=>`<button class="cat-opt ${b.cat===c.id?'picked':''}" onclick="changeCat('${id}','${c.id}',this)">${c.emoji} ${c.label}</button>`).join('')}</div>
    <div class="detail-divider"></div>
    <button class="sbtn secondary" style="margin-bottom:10px" onclick="toggleWishlist('${id}')">${b.wishlist ? 'üìö Mover a Biblioteca' : 'üõí Mover a Wishlist'}</button>
    ${!b.wishlist&&!b.read?`<button class="sbtn" style="margin-bottom:10px; background:var(--green-dim); color:var(--green); border:1px solid var(--green);" onclick="toggleRead('${id}');closeDetail()">‚úÖ Marcar como le√≠do</button>`:''}
    ${!b.wishlist&&!b.read&&!b.startDate?`<button class="sbtn" style="margin-bottom:10px" onclick="startReadingBook('${id}');closeDetail()">üìñ Empezar a leer</button>`:''}
    ${!b.wishlist&&b.read?`<button class="sbtn secondary" style="margin-bottom:10px" onclick="markUnread('${id}')">‚Ü© Marcar como no le√≠do</button>`:''}
    <button class="sbtn danger" onclick="del('${id}');closeDetail()">üóë Eliminar libro</button>
  `;
  document.getElementById('detOv').classList.add('open');
  document.getElementById('detSh').classList.add('open');
}

function closeDetail(){document.getElementById('detOv').classList.remove('open');document.getElementById('detSh').classList.remove('open');detailBookId=null;renderAll()}

function setRating(id,r){
  const b=books.find(x=>x.id===id);if(!b)return;
  b.rating=b.rating===r?0:r;save();openDetail(id);
}

function saveNotes(id){
  const b=books.find(x=>x.id===id);if(!b)return;
  const el=document.getElementById('detNotes');if(el)b.notes=el.value;save();
}

function changeCat(id,cat,el){
  const b=books.find(x=>x.id===id);if(!b)return;
  b.cat=cat;save();
  el.parentElement.querySelectorAll('.cat-opt').forEach(o=>o.classList.remove('picked'));
  el.classList.add('picked');
}

function markUnread(id){
  const b=books.find(x=>x.id===id);if(!b)return;
  b.read=false;b.readDate=null;save();openDetail(id);
}

function updateBookData(id){
  const b=books.find(x=>x.id===id);if(!b)return;
  const t = document.getElementById('editTitleIn').value.trim();
  const a = document.getElementById('editAuthorIn').value.trim();
  b.title = a ? `${a} ‚Äì ${t}` : t;
  save(); renderAll();
}

function toggleWishlist(id){
  const b=books.find(x=>x.id===id);if(!b)return;
  b.wishlist=!b.wishlist;save();closeDetail();
  toast(b.wishlist?'Movido a Wishlist üõí':'Movido a Biblioteca üìö');
}

// ‚ïê‚ïê‚ïê SWIPE ‚ïê‚ïê‚ïê
let touchStartX=0,touchId=null;
function tStart(e,id){touchStartX=e.touches[0].clientX;touchId=id}
function tMove(e,id){
  if(touchId!==id)return;
  const dx=e.touches[0].clientX-touchStartX;
  if(dx<-30){e.currentTarget.style.transform=`translateX(${Math.max(dx,-80)}px)`;e.currentTarget.classList.add('swiping')}
}
function tEnd(e,id){
  if(touchId!==id)return;
  const card=e.currentTarget;
  const dx=e.changedTouches[0].clientX-touchStartX;
  if(dx<-60){del(id)}
  else{card.style.transform='';card.classList.remove('swiping')}
  touchId=null;
}

// ‚ïê‚ïê‚ïê SETTINGS ‚ïê‚ïê‚ïê
function saveGoal(){state.goal=parseInt(document.getElementById('goalIn').value)||20;saveState();if(currentPage==='stats')renderStats()}
function resetLib(){
  if(!confirm('¬øReiniciar toda la biblioteca?'))return;
  localStorage.removeItem('bp3_books');localStorage.removeItem('bp3_state');
  books=DB.map(b=>({id:gid(),title:b.t,cat:b.c,read:false,rating:0,notes:'',readDate:null,startDate:null}));
  state={currentlyReading:null,goal:20,sortIdx:0,filter:'all',catFilter:'all'};
  save();saveState();renderAll();toast('Biblioteca reiniciada');
}
function exportData(){
  const data=JSON.stringify({books,state},null,2);
  const blob=new Blob([data],{type:'application/json'});
  const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='bookpick-backup.json';a.click();
  toast('Datos exportados ‚úì');
}

function toggleTheme(){
  const isLight = document.body.getAttribute('data-theme') === 'light';
  if(isLight) {
    document.body.removeAttribute('data-theme');
    localStorage.setItem('bp_theme', 'dark');
    document.querySelectorAll('.theme-btn').forEach(btn => btn.textContent = '‚òÄÔ∏è');
    document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0C0C0C');
  } else {
    document.body.setAttribute('data-theme', 'light');
    localStorage.setItem('bp_theme', 'light');
    document.querySelectorAll('.theme-btn').forEach(btn => btn.textContent = 'üåô');
    document.querySelector('meta[name="theme-color"]').setAttribute('content', '#F4F4F5');
  }
}

function importData(e){
  const file=e.target.files[0]; if(!file)return;
  const reader=new FileReader();
  reader.onload=function(ev){
    try{
      const d=JSON.parse(ev.target.result);
      if(d.books && d.state) {
        // Migraci√≥n de datos viejos al nuevo formato
        d.books.forEach(b=>{
          if(b.rating===undefined)b.rating=0;
          if(!b.notes)b.notes='';
          if(!b.readDate)b.readDate=null;
          if(!b.startDate)b.startDate=null;
          if(b.wishlist===undefined)b.wishlist=false;
          if(b.progress===undefined)b.progress=0;
        });
        books=d.books; state=d.state;
        save(); saveState(); renderAll(); toast('Backup restaurado ‚úì');
      } else throw new Error();
    }catch(err){toast('Archivo inv√°lido ‚ùå')}
  };
  reader.readAsText(file);
}

// ‚ïê‚ïê‚ïê HELPERS ‚ïê‚ïê‚ïê
function formatDate(d){if(!d)return'';const[y,m,day]=d.split('-');return`${parseInt(day)}/${parseInt(m)}/${y}`}
function toast(m){const t=document.getElementById('toast');t.textContent=m;t.classList.add('show');setTimeout(()=>t.classList.remove('show'),2200)}

// ‚ïê‚ïê‚ïê CANVAS EXPORT (INSTAGRAM STORY) ‚ïê‚ïê‚ïê
function shareTop5() {
  const readBooks = books.filter(b => b.read && b.rating > 0).sort((a, b) => b.rating - a.rating);
  if (readBooks.length === 0) { toast('¬°Calific√° libros le√≠dos primero!'); return; }
  
  const top5 = readBooks.slice(0, 5);
  const canvas = document.createElement('canvas');
  const ctx = canvas.getContext('2d');
  
  // Tama√±o Story de IG
  canvas.width = 1080; 
  canvas.height = 1920;
  
  // Fondo oscuro con gradiente
  const gradient = ctx.createLinearGradient(0, 0, 0, 1920);
  gradient.addColorStop(0, '#0C0C0C');
  gradient.addColorStop(1, '#1A1A1A');
  ctx.fillStyle = gradient;
  ctx.fillRect(0, 0, 1080, 1920);

  // Efecto Glow superior
  const glow = ctx.createRadialGradient(540, 200, 50, 540, 200, 600);
  glow.addColorStop(0, 'rgba(232,160,76,0.15)');
  glow.addColorStop(1, 'transparent');
  ctx.fillStyle = glow;
  ctx.fillRect(0, 0, 1080, 1920);

  // T√≠tulo
  ctx.fillStyle = '#E8A04C'; // Accent color
  ctx.font = 'bold 80px "Playfair Display", serif';
  ctx.textAlign = 'center';
  ctx.fillText('Mi Top Lecturas', 540, 300);
  
  ctx.fillStyle = '#C4BFB6';
  ctx.font = '40px "Outfit", sans-serif';
  ctx.fillText('BookPick üìö', 540, 370);

  // Dibujar los libros
  let startY = 550;
  top5.forEach((b, index) => {
    const { a, t } = parse(b.title);
    
    // Caja de la tarjeta
    ctx.fillStyle = '#202020';
    ctx.roundRect = function(x, y, w, h, r) {
      this.beginPath(); this.moveTo(x+r, y); this.lineTo(x+w-r, y); this.quadraticCurveTo(x+w, y, x+w, y+r); this.lineTo(x+w, y+h-r); this.quadraticCurveTo(x+w, y+h, x+w-r, y+h); this.lineTo(x+r, y+h); this.quadraticCurveTo(x, y+h, x, y+h-r); this.lineTo(x, y+r); this.quadraticCurveTo(x, y, x+r, y); this.closePath();
    };
    ctx.roundRect(140, startY, 800, 200, 24);
    ctx.fill();

    // N√∫mero
    ctx.fillStyle = 'rgba(232,160,76,0.2)';
    ctx.font = 'bold 120px "Playfair Display", serif';
    ctx.textAlign = 'left';
    ctx.fillText(`#${index + 1}`, 180, startY + 140);

    // T√≠tulo
    ctx.fillStyle = '#F0EDE8';
    ctx.font = 'bold 45px "Playfair Display", serif';
    ctx.textAlign = 'left';
    let titleText = t || b.title;
    if (titleText.length > 25) titleText = titleText.substring(0, 25) + '...';
    ctx.fillText(titleText, 320, startY + 90);

    // Autor
    ctx.fillStyle = '#C4BFB6';
    ctx.font = '35px "Outfit", sans-serif';
    ctx.fillText(a ? (a.length > 30 ? a.substring(0, 30) + '...' : a) : 'Autor Desconocido', 320, startY + 150);

    // Estrellas
    ctx.fillStyle = '#E8A04C';
    ctx.font = '35px Arial'; // Arial suele renderizar mejor las estrellas
    ctx.textAlign = 'right';
    ctx.fillText('‚òÖ'.repeat(b.rating), 900, startY + 120);

    startY += 240;
  });

  // Footer
  ctx.fillStyle = '#7A756D';
  ctx.font = '35px "Outfit", sans-serif';
  ctx.textAlign = 'center';
  ctx.fillText('Arm√° el tuyo en BookPick App', 540, 1820);

  // Descargar la imagen
  try {
    const dataUrl = canvas.toDataURL('image/jpeg', 0.9);
    const link = document.createElement('a');
    link.download = `BookPick-Top5-${today()}.jpg`;
    link.href = dataUrl;
    link.click();
    toast('¬°Imagen generada! Lista para IG üì∏');
  } catch (err) {
    console.error(err);
    toast('Error al generar la imagen ‚ùå');
  }
}

// ‚ïê‚ïê‚ïê INIT & PWA ‚ïê‚ïê‚ïê
init();renderAll();

if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('sw.js')
      .then(reg => console.log('SW Registrado exitosamente'))
      .catch(err => console.log('SW Error al registrar', err));
  });
}
</script>
</body>
</html>
